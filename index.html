<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IT Look Â· Radar de Performance</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    let AVG_CTR = 0;

    const STATUS_MAP = {
      "estrela": "estrela",
      "alto interesse": "alto_interesse",
      "alto_interesse": "alto_interesse",
      "normal": "normal",
      "problema": "problema",
      "invisivel": "invisivel",
      "invisÃ­vel": "invisivel",
    };

    function normalizeStatus(raw) {
      if (!raw) return null;
      return STATUS_MAP[raw.toString().toLowerCase().trim()] || null;
    }

    function classify(p) {
      const hasPurchases = p.compras >= 1;
      const hasCart = p.carrinho > 0;
      const highImpressions = p.impressoes > 200;
      const highCTR = AVG_CTR > 0 ? p.ctr >= AVG_CTR : p.ctr > 0;
      if (hasPurchases && (highCTR || p.compras >= 2)) return "estrela";
      if (highImpressions && hasCart && p.compras === 0) return "problema";
      if (highCTR && !hasPurchases) return "alto_interesse";
      if (p.impressoes < 50 && p.compras === 0) return "invisivel";
      return "normal";
    }

    function calcScore(p) {
      switch (p.status) {
        case "estrela":
          return (p.compras || 0) * (p.ctr || 0) * (p.conversion_rate || 0);
        case "alto_interesse":
          return (p.cliques || 0) * (p.ctr || 0);
        case "problema":
          return (p.impressoes || 0) * (p.add_rate || 0);
        default:
          return p.impressoes || 0;
      }
    }

    function getRecomendacao(p) {
      const temImpressoes = p.impressoes >= 200;
      const temCliques = p.cliques > 0;
      const temCarrinho = p.carrinho > 0;
      const temVendas = p.compras > 0;
      const ctrBaixo = p.ctr === 0 || (AVG_CTR > 0 && p.ctr < AVG_CTR * 0.5);

      if (p.status === "estrela") {
        return {
          icone: "â˜…",
          titulo: "Produto funcionando bem",
          acoes: [
            "ðŸ“¦ Garanta estoque suficiente â€” este produto estÃ¡ convertendo",
            "ðŸ“¸ Mesmo assim, melhorar a foto pode aumentar ainda mais o CTR",
            "ðŸ’° Teste aumentar o preÃ§o em 5â€“10% e veja se a conversÃ£o se mantÃ©m",
          ]
        };
      }

      if (p.status === "problema") {
        if (temCarrinho && !temVendas) {
          return {
            icone: "âš ",
            titulo: "Interesse alto, mas tranca na hora de comprar",
            acoes: [
              "ðŸ’° PREÃ‡O â€” revise se estÃ¡ competitivo. Compare com produtos similares no mercado",
              "ðŸšš Verifique se o frete estÃ¡ afastando o cliente na hora do checkout",
              "ðŸ“¸ Fotos adicionais mostrando detalhes (tecido, caimento) podem dar mais seguranÃ§a para comprar",
            ]
          };
        }
        return {
          icone: "âš ",
          titulo: "Muita exposiÃ§Ã£o mas sem resultado",
          acoes: [
            "ðŸ“¸ FOTO â€” a imagem principal nÃ£o estÃ¡ vendendo o produto. Troque por uma foto com mais impacto visual",
            "ðŸ’° Revise o preÃ§o â€” pode estar acima do que o cliente percebe como valor",
            "ðŸ‘— Avalie se o produto tem apelo para o pÃºblico da IT Look (mulher 45â€“55, ocasiÃ£o noturna)",
          ]
        };
      }

      if (p.status === "alto_interesse") {
        return {
          icone: "â†‘",
          titulo: "Clica mas nÃ£o compra",
          acoes: [
            "ðŸ’° PREÃ‡O Ã© o principal suspeito â€” o cliente se interessa mas nÃ£o converte",
            "ðŸ“¸ Revise as fotos adicionais dentro do produto â€” a primeira foto atrai, mas as demais precisam convencer",
            "ðŸ‘— Melhore a descriÃ§Ã£o: medidas, tecido, ocasiÃ£o de uso ajudam a dar seguranÃ§a para comprar",
          ]
        };
      }

      if (p.status === "invisivel") {
        return {
          icone: "â—‹",
          titulo: "Produto invisÃ­vel â€” quase ninguÃ©m vÃª",
          acoes: [
            "ðŸ“¸ FOTO â€” no grid da loja, a imagem precisa se destacar para gerar clique. Invista em foto de impacto",
            "ðŸ· Revise o tÃ­tulo: inclua palavras que sua cliente busca (blazer festa, blusa elegante, calÃ§a social)",
            "ðŸ“£ Considere impulsionar este produto com um anÃºncio de baixo custo para gerar primeiros dados",
          ]
        };
      }

      if (!temImpressoes && !temCliques) {
        return {
          icone: "â—Ž",
          titulo: "Produto com pouca exposiÃ§Ã£o ainda",
          acoes: [
            "ðŸ“¸ FOTO â€” comece pela imagem principal. No grid da loja, a foto Ã© o que decide o clique",
            "ðŸ· Revise o tÃ­tulo e as tags para aparecer melhor nas buscas",
            "ðŸ’° Verifique se o preÃ§o estÃ¡ alinhado com produtos similares da IT Look",
          ]
        };
      }

      if (temImpressoes && !temCliques && !temVendas) {
        return {
          icone: "â—Ž",
          titulo: "Aparece mas ninguÃ©m clica",
          acoes: [
            "ðŸ“¸ FOTO URGENTE â€” o produto aparece mas nÃ£o atrai. A foto principal Ã© o principal problema",
            "ðŸ· Teste um tÃ­tulo diferente que comunique melhor o benefÃ­cio (ex: 'Blazer Alfaiataria Festa')",
            "ðŸ’° Verifique se o preÃ§o exibido no grid estÃ¡ competitivo",
          ]
        };
      }

      return {
        icone: "â—Ž",
        titulo: "Produto em desenvolvimento",
        acoes: [
          "ðŸ“¸ Avalie a qualidade da foto â€” Ã© o primeiro filtro do cliente",
          "ðŸ’° Compare o preÃ§o com produtos similares",
          "ðŸ‘— Revise se o produto estÃ¡ bem posicionado para o pÃºblico IT Look",
        ]
      };
    }

    const STATUS = {
      estrela:        { label: "Estrela",        icon: "â˜…", text: "#2D5A3D", bg: "#EDF4EF", border: "#C2D9C9", dot: "#5A9970", pillBg: "#E0EEE5" },
      alto_interesse: { label: "Alto Interesse", icon: "â†‘", text: "#1E3A5F", bg: "#EDF2F8", border: "#B8CEEA", dot: "#5A7FA8", pillBg: "#DDE9F5" },
      normal:         { label: "Normal",         icon: "â—Ž", text: "#6B5A00", bg: "#FBF8EE", border: "#E8D98A", dot: "#C4A832", pillBg: "#F5EDBB" },
      problema:       { label: "Problema",       icon: "!", text: "#6B2020", bg: "#FAF0F0", border: "#E8B8B8", dot: "#C45A5A", pillBg: "#F5DADA" },
      invisivel:      { label: "InvisÃ­vel",      icon: "â—‹", text: "#5C5470", bg: "#F3F1F8", border: "#D4CEEA", dot: "#9B92C0", pillBg: "#EAE7F5" },
    };

    const ORDER = ["estrela", "alto_interesse", "normal", "problema", "invisivel"];
    const fmt = n => (typeof n === "number" && !isNaN(n)) ? n.toLocaleString("pt-BR") : "â€”";

    function Tag({ s }) {
      return (
        <span style={{
          display: "inline-flex", alignItems: "center", gap: 4,
          fontFamily: "'DM Sans', sans-serif", fontSize: 10, fontWeight: 600,
          color: s.text, background: s.pillBg, border: `1px solid ${s.border}`,
          borderRadius: 20, padding: "3px 10px", letterSpacing: 0.8, whiteSpace: "nowrap"
        }}>
          {s.icon} {s.label.toUpperCase()}
        </span>
      );
    }

    function Pill({ label, value, color }) {
      return (
        <div style={{ display: "flex", flexDirection: "column", gap: 2 }}>
          <span style={{ fontSize: 9, color: "#B0A898", letterSpacing: 0.8, fontWeight: 500 }}>{label.toUpperCase()}</span>
          <span style={{ fontSize: 13, fontWeight: 500, color: color || "#374151" }}>{value}</span>
        </div>
      );
    }

    function ImagePlaceholder({ name, s }) {
      const initials = name
        ? name.trim().split(" ").slice(0, 2).map(w => w[0]).join("").toUpperCase()
        : "IT";
      return (
        <div style={{
          width: "100%", height: "100%", minHeight: 80,
          background: s.pillBg,
          display: "flex", flexDirection: "column",
          alignItems: "center", justifyContent: "center", gap: 2,
        }}>
          <span style={{ fontSize: 15, fontWeight: 700, color: s.dot, letterSpacing: 1 }}>{initials}</span>
          <span style={{ fontSize: 7, color: s.dot, opacity: 0.6, letterSpacing: 0.5 }}>SEM FOTO</span>
        </div>
      );
    }

    function ProductCard({ p }) {
      const [open, setOpen] = useState(false);
      const [imgError, setImgError] = useState(false);
      const s = STATUS[p.status];

      const convRate = p.impressoes > 0 ? ((p.compras / p.impressoes) * 100).toFixed(2) + "%" : "â€”";
      const addRate  = p.impressoes > 0 ? ((p.carrinho / p.impressoes) * 100).toFixed(2) + "%" : "â€”";

      return (
        <div
          style={{
            background: open ? s.bg : "#fff",
            border: `1.5px solid ${open ? s.border : "#ECEAE6"}`,
            borderRadius: 12,
            marginBottom: 10,
            overflow: "hidden",
            transition: "all 0.18s",
            cursor: "pointer",
          }}
          onClick={() => setOpen(o => !o)}
          onMouseEnter={e => { if (!open) e.currentTarget.style.borderColor = s.border; }}
          onMouseLeave={e => { if (!open) e.currentTarget.style.borderColor = "#ECEAE6"; }}
        >
          <div style={{ display: "flex", alignItems: "stretch", gap: 0 }}>
            <div style={{ width: 72, flexShrink: 0, position: "relative", overflow: "hidden" }}>
              {p.img && !imgError ? (
                <img
                  src={p.img}
                  alt={p.name}
                  style={{ width: "100%", height: "100%", objectFit: "cover", display: "block", minHeight: 80 }}
                  onError={() => setImgError(true)}
                />
              ) : (
                <ImagePlaceholder name={p.name} s={s} />
              )}
              <div style={{
                position: "absolute", top: 8, left: 8,
                width: 8, height: 8, borderRadius: "50%",
                background: s.dot, boxShadow: "0 0 0 2px white"
              }} />
            </div>

            <div style={{ flex: 1, padding: "14px 16px", display: "flex", alignItems: "center", justifyContent: "space-between", gap: 12 }}>
              <div style={{ flex: 1, minWidth: 0 }}>
                <div style={{ fontSize: 13, fontWeight: 500, color: "#1a1a1a", marginBottom: 10, whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>
                  {p.name}
                </div>
                <div style={{ display: "flex", gap: 20, flexWrap: "wrap" }}>
                  <Pill label="ImpressÃµes" value={fmt(p.impressoes)} />
                  <Pill label="CTR" value={`${(p.ctr || 0).toFixed(1)}%`} color={p.ctr >= AVG_CTR ? s.text : "#6B7280"} />
                  <Pill label="Carrinho" value={p.carrinho} color={p.carrinho > 0 ? "#2D6A4F" : "#9CA3AF"} />
                  <Pill label="Compras" value={p.compras} color={p.compras > 0 ? s.text : "#9CA3AF"} />
                </div>
              </div>

              <div style={{ display: "flex", flexDirection: "column", alignItems: "flex-end", gap: 8, flexShrink: 0 }}>
                {p.compras > 0 && (
                  <div style={{ textAlign: "right" }}>
                    <div style={{ fontSize: 28, fontWeight: 700, color: s.dot, lineHeight: 1 }}>{p.compras}</div>
                    <div style={{ fontSize: 9, color: "#B0A898", letterSpacing: 0.8, marginTop: 2 }}>VENDAS</div>
                  </div>
                )}
                <Tag s={s} />
              </div>
            </div>
          </div>

          {open && (
            <div style={{ padding: "14px 16px 16px", borderTop: `1px solid ${s.border}`, background: s.bg }}>
              <div style={{ display: "flex", gap: 10, flexWrap: "wrap" }}>
                {[
                  { label: "Cliques",    value: fmt(p.cliques) },
                  { label: "Add Rate",   value: addRate },
                  { label: "Conv. Rate", value: convRate },
                  { label: "CTR mÃ©dio",  value: `${AVG_CTR.toFixed(1)}%` },
                ].map(({ label, value }) => (
                  <div key={label} style={{ background: "#fff", borderRadius: 8, padding: "10px 12px", border: `1px solid ${s.border}` }}>
                    <div style={{ fontSize: 9, color: "#B0A898", letterSpacing: 0.8, marginBottom: 4, fontWeight: 500 }}>{label.toUpperCase()}</div>
                    <div style={{ fontSize: 16, fontWeight: 600, color: s.text }}>{value}</div>
                  </div>
                ))}
              </div>

              {(() => {
                const rec = getRecomendacao(p);
                return (
                  <div style={{ marginTop: 12, background: s.pillBg, border: `1px solid ${s.border}`, borderRadius: 8, padding: "12px 14px" }}>
                    <div style={{ fontSize: 12, fontWeight: 600, color: s.text, marginBottom: 8 }}>
                      {rec.icone} {rec.titulo}
                    </div>
                    <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                      {rec.acoes.map((acao, i) => (
                        <div key={i} style={{ fontSize: 12, color: s.text, lineHeight: 1.5 }}>{acao}</div>
                      ))}
                    </div>
                  </div>
                );
              })()}
            </div>
          )}
        </div>
      );
    }

    function GroupSection({ statusKey, products }) {
      const [collapsed, setCollapsed] = useState(false);
      const s = STATUS[statusKey];
      if (products.length === 0) return null;
      const totalPurchases = products.reduce((a, p) => a + (p.compras || 0), 0);

      return (
        <div style={{ marginBottom: 28 }}>
          <div
            onClick={() => setCollapsed(c => !c)}
            style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12, cursor: "pointer", userSelect: "none" }}
          >
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <Tag s={s} />
              <span style={{ fontSize: 12, color: "#B0A898" }}>{products.length} produto{products.length !== 1 ? "s" : ""}</span>
              {totalPurchases > 0 && <span style={{ fontSize: 12, color: s.text, fontWeight: 500 }}>Â· {totalPurchases} venda{totalPurchases !== 1 ? "s" : ""}</span>}
            </div>
            <span style={{ fontSize: 10, color: "#C4BFB8", transform: collapsed ? "rotate(180deg)" : "none", transition: "transform 0.2s" }}>â–²</span>
          </div>
          {!collapsed && products.map(p => <ProductCard key={p.id || p.produto} p={p} />)}
        </div>
      );
    }

    function RadarPerformance() {
      const [search, setSearch] = useState("");
      const [products, setProducts] = React.useState([]);
      const [loading, setLoading] = React.useState(true);

      React.useEffect(() => {
        Promise.all([
          fetch("/api/products").then(res => res.json()),
          fetch("/api/product-images").then(res => res.json()).catch(() => ({ imageMap: {} }))
        ]).then(([data, imgData]) => {
          const imageMap = imgData.imageMap || {};

          const mapped = data.products.map(p => {
            const nomeKey = p.produto?.toLowerCase().trim();
            const img = imageMap[nomeKey] || null;
            return { ...p, name: p.produto, img };
          });

          AVG_CTR = mapped.length > 0
            ? mapped.reduce((s, p) => s + (p.ctr || 0), 0) / mapped.length
            : 0;

          const withStatus = mapped.map(p => ({
            ...p,
            status: normalizeStatus(p.status_inteligente) || classify(p)
          }));

          const sorted = withStatus.sort((a, b) => {
            const orderA = ORDER.indexOf(a.status);
            const orderB = ORDER.indexOf(b.status);
            if (orderA !== orderB) return orderA - orderB;
            const scoreA = a.score_ordem != null ? a.score_ordem : calcScore(a);
            const scoreB = b.score_ordem != null ? b.score_ordem : calcScore(b);
            return scoreB - scoreA;
          });

          setProducts(sorted);
          setLoading(false);
        })
        .catch(() => setLoading(false));
      }, []);

      if (loading) return (
        <div style={{ display: "flex", justifyContent: "center", alignItems: "center", height: "100vh", fontFamily: "'DM Sans', sans-serif", color: "#B0A898" }}>
          Carregando...
        </div>
      );

      const filtered = products.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));
      const grouped = {};
      ORDER.forEach(k => { grouped[k] = filtered.filter(p => p.status === k); });

      const totalVendas = products.reduce((a, p) => a + (p.compras || 0), 0);
      const totalImpressoes = products.reduce((a, p) => a + (p.impressoes || 0), 0);
      const estrelas = products.filter(p => p.status === "estrela").length;
      const problemas = products.filter(p => p.status === "problema" || p.status === "invisivel").length;

      return (
        <div style={{ fontFamily: "'DM Sans', sans-serif", background: "#F7F6F3", minHeight: "100vh", color: "#1a1a1a" }}>
          <style>{`@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap'); * { box-sizing: border-box; margin: 0; padding: 0; }`}</style>

          <div style={{ background: "#fff", borderBottom: "1px solid #ECEAE6", padding: "0 40px" }}>
            <div style={{ maxWidth: 960, margin: "0 auto", display: "flex", alignItems: "center", justifyContent: "space-between", height: 58 }}>
              <div style={{ display: "flex", alignItems: "center", gap: 20 }}>
                <span style={{ fontSize: 16, fontWeight: 700, letterSpacing: 3, color: "#1a1a1a" }}>IT LOOK</span>
                <span style={{ width: 1, height: 14, background: "#E0DDD8" }} />
                <span style={{ fontSize: 11, color: "#B0A898", letterSpacing: 1.5, fontWeight: 500 }}>RADAR DE PERFORMANCE</span>
              </div>
              <div style={{ width: 30, height: 30, borderRadius: "50%", background: "#C9A84C", display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 12, fontWeight: 600 }}>D</div>
            </div>
          </div>

          <div style={{ maxWidth: 960, margin: "0 auto", padding: "32px 40px" }}>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 12, marginBottom: 32 }}>
              {[
                { label: "Vendas Totais",     value: totalVendas,          sub: "Ãºltimos 30 dias",      color: STATUS.estrela.text },
                { label: "ImpressÃµes",        value: fmt(totalImpressoes), sub: "alcance total",        color: "#374151" },
                { label: "Produtos Estrela",  value: estrelas,             sub: "CTR alto + vendas",    color: STATUS.estrela.dot },
                { label: "Precisam AtenÃ§Ã£o",  value: problemas,            sub: "problema + invisÃ­vel", color: STATUS.problema.dot },
              ].map(({ label, value, sub, color }) => (
                <div key={label} style={{ background: "#fff", border: "1.5px solid #ECEAE6", borderRadius: 10, padding: "16px 18px" }}>
                  <div style={{ fontSize: 10, color: "#B0A898", letterSpacing: 1, marginBottom: 8, fontWeight: 500 }}>{label.toUpperCase()}</div>
                  <div style={{ fontSize: 30, fontWeight: 700, color, lineHeight: 1 }}>{value}</div>
                  <div style={{ fontSize: 11, color: "#B0A898", marginTop: 5 }}>{sub}</div>
                </div>
              ))}
            </div>

            <input
              placeholder="Buscar produto..."
              value={search}
              onChange={e => setSearch(e.target.value)}
              style={{ fontFamily: "'DM Sans', sans-serif", fontSize: 13, border: "1.5px solid #E0DDD8", borderRadius: 8, padding: "9px 14px", width: 250, background: "#fff", color: "#1a1a1a", outline: "none", marginBottom: 24 }}
            />

            {ORDER.map(k => <GroupSection key={k} statusKey={k} products={grouped[k]} />)}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<RadarPerformance />);
  </script>
</body>
</html>
