<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Radar de Performance Â· IT LOOK</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --black: #0a0a0a;
    --off-white: #f5f0eb;
    --gold: #c9a84c;
    --gold-light: #e8d5a3;
    --gold-dim: rgba(201,168,76,0.15);
    --gray: #6b6560;
    --gray-light: #e8e3de;
    --surface: #111111;
    --surface2: #1a1a1a;
    --border: rgba(201,168,76,0.2);

    --estrela: #c9a84c;
    --interesse: #e05c2a;
    --problema: #d4a017;
    --normal: #7a9cb8;
    --invisivel: #555555;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--black);
    color: var(--off-white);
    font-family: 'DM Sans', sans-serif;
    font-weight: 300;
    min-height: 100vh;
  }

  /* â”€â”€ LOGIN â”€â”€ */
  #login-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    gap: 48px;
    background: var(--black);
    position: relative;
    overflow: hidden;
  }

  #login-screen::before {
    content: '';
    position: absolute;
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(201,168,76,0.08) 0%, transparent 70%);
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
  }

  .login-logo {
    font-family: 'Cormorant Garamond', serif;
    font-size: 13px;
    font-weight: 400;
    letter-spacing: 0.4em;
    color: var(--gold);
    text-transform: uppercase;
  }

  .login-title {
    text-align: center;
  }

  .login-title h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(36px, 6vw, 64px);
    font-weight: 300;
    line-height: 1.1;
    letter-spacing: -0.02em;
    color: var(--off-white);
  }

  .login-title h1 em {
    font-style: italic;
    color: var(--gold);
  }

  .login-title p {
    margin-top: 12px;
    font-size: 13px;
    color: var(--gray);
    letter-spacing: 0.05em;
  }

  .btn-google {
    display: flex;
    align-items: center;
    gap: 12px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--off-white);
    padding: 14px 28px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 400;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .btn-google::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--gold-dim);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .btn-google:hover::before { opacity: 1; }
  .btn-google:hover { border-color: var(--gold); }

  .btn-google svg { flex-shrink: 0; }

  /* â”€â”€ MAIN APP â”€â”€ */
  #app { display: none; }

  header {
    border-bottom: 1px solid var(--border);
    padding: 20px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .header-brand {
    font-family: 'Cormorant Garamond', serif;
    font-size: 11px;
    letter-spacing: 0.5em;
    color: var(--gold);
    text-transform: uppercase;
  }

  .header-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 18px;
    font-weight: 300;
    letter-spacing: 0.1em;
    color: var(--off-white);
  }

  .header-user {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    color: var(--gray);
  }

  .user-dot {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: var(--gold-dim);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Cormorant Garamond', serif;
    font-size: 14px;
    color: var(--gold);
  }

  main { padding: 40px; max-width: 1400px; margin: 0 auto; }

  /* â”€â”€ KPI CARDS â”€â”€ */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1px;
    background: var(--border);
    margin-bottom: 40px;
    border: 1px solid var(--border);
  }

  .kpi-card {
    background: var(--surface);
    padding: 24px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
  }

  .kpi-card::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 2px;
    background: transparent;
    transition: background 0.2s;
  }

  .kpi-card:hover { background: var(--surface2); }
  .kpi-card.active::after { background: var(--card-color, var(--gold)); }
  .kpi-card.active { background: var(--surface2); }

  .kpi-icon { font-size: 20px; margin-bottom: 12px; display: block; }

  .kpi-label {
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--gray);
    margin-bottom: 8px;
  }

  .kpi-value {
    font-family: 'Cormorant Garamond', serif;
    font-size: 40px;
    font-weight: 300;
    line-height: 1;
    color: var(--card-color, var(--off-white));
  }

  .kpi-sub {
    font-size: 11px;
    color: var(--gray);
    margin-top: 4px;
  }

  /* â”€â”€ FILTER BAR â”€â”€ */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .section-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    font-weight: 300;
    letter-spacing: 0.05em;
    color: var(--off-white);
  }

  .filter-pills {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .pill {
    padding: 6px 16px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--gray);
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.2s;
  }

  .pill:hover { border-color: var(--gold); color: var(--off-white); }

  .pill.active {
    background: var(--gold-dim);
    border-color: var(--gold);
    color: var(--gold);
  }

  /* â”€â”€ TABLE â”€â”€ */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead th {
    padding: 14px 20px;
    text-align: left;
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--gray);
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    transition: color 0.2s;
  }

  thead th:hover { color: var(--gold); }

  tbody tr {
    border-bottom: 1px solid rgba(201,168,76,0.06);
    transition: background 0.15s;
  }

  tbody tr:hover { background: var(--surface2); }
  tbody tr:last-child { border-bottom: none; }

  td {
    padding: 14px 20px;
    font-size: 13px;
    color: var(--off-white);
    white-space: nowrap;
  }

  td.produto-cell {
    font-family: 'Cormorant Garamond', serif;
    font-size: 15px;
    font-weight: 400;
    max-width: 260px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  td.num { color: var(--gray-light); font-variant-numeric: tabular-nums; }
  td.pct { font-variant-numeric: tabular-nums; }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    font-size: 10px;
    letter-spacing: 0.05em;
    border: 1px solid currentColor;
    opacity: 0.9;
  }

  .badge-estrela    { color: var(--estrela); }
  .badge-interesse  { color: var(--interesse); }
  .badge-problema   { color: var(--problema); }
  .badge-normal     { color: var(--normal); }
  .badge-invisivel  { color: var(--invisivel); }

  .action-btn {
    padding: 5px 14px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--gold);
    font-family: 'DM Sans', sans-serif;
    font-size: 10px;
    letter-spacing: 0.1em;
    cursor: pointer;
    transition: all 0.2s;
  }

  .action-btn:hover {
    background: var(--gold-dim);
    border-color: var(--gold);
  }

  /* â”€â”€ EMPTY / LOADING â”€â”€ */
  .state-msg {
    text-align: center;
    padding: 60px;
    color: var(--gray);
    font-size: 13px;
    letter-spacing: 0.05em;
  }

  .state-msg span {
    display: block;
    font-family: 'Cormorant Garamond', serif;
    font-size: 32px;
    font-weight: 300;
    color: var(--gold-light);
    margin-bottom: 8px;
  }

  /* â”€â”€ SEARCH â”€â”€ */
  .search-wrap {
    position: relative;
  }

  input[type="text"] {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--off-white);
    padding: 10px 16px;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    width: 220px;
    outline: none;
    transition: border-color 0.2s;
  }

  input[type="text"]::placeholder { color: var(--gray); }
  input[type="text"]:focus { border-color: var(--gold); }

  /* â”€â”€ MODAL â”€â”€ */
  #modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }

  #modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 40px;
    width: 480px;
    max-width: 90vw;
    position: relative;
  }

  .modal h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    font-weight: 300;
    margin-bottom: 6px;
    color: var(--off-white);
  }

  .modal .modal-status {
    font-size: 11px;
    color: var(--gray);
    letter-spacing: 0.1em;
    margin-bottom: 28px;
  }

  .modal-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 28px;
  }

  .modal-stat { border-left: 2px solid var(--border); padding-left: 12px; }
  .modal-stat .label { font-size: 10px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--gray); margin-bottom: 4px; }
  .modal-stat .val {
    font-family: 'Cormorant Garamond', serif;
    font-size: 28px;
    font-weight: 300;
    color: var(--off-white);
  }

  .modal-actions { display: flex; gap: 10px; flex-wrap: wrap; }

  .modal-action-btn {
    padding: 10px 18px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--off-white);
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.2s;
  }

  .modal-action-btn:hover { border-color: var(--gold); color: var(--gold); background: var(--gold-dim); }
  .modal-action-btn.primary { background: var(--gold); color: var(--black); border-color: var(--gold); font-weight: 500; }
  .modal-action-btn.primary:hover { background: var(--gold-light); }

  .modal-close {
    position: absolute;
    top: 16px; right: 16px;
    background: none;
    border: none;
    color: var(--gray);
    font-size: 20px;
    cursor: pointer;
    line-height: 1;
    transition: color 0.2s;
  }
  .modal-close:hover { color: var(--off-white); }

  /* â”€â”€ ANIMATIONS â”€â”€ */
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .animate-in { animation: fadeIn 0.4s ease forwards; }

  .loading-dot::after {
    content: '';
    display: inline-block;
    animation: dots 1.2s infinite;
  }
  @keyframes dots {
    0%   { content: ''; }
    33%  { content: '.'; }
    66%  { content: '..'; }
    100% { content: '...'; }
  }

  /* â”€â”€ RESPONSIVE â”€â”€ */
  @media (max-width: 900px) {
    main { padding: 20px; }
    header { padding: 16px 20px; }
    .kpi-grid { grid-template-columns: repeat(3, 1fr); }
  }

  @media (max-width: 600px) {
    .kpi-grid { grid-template-columns: 1fr 1fr; }
    .section-header { flex-direction: column; gap: 12px; align-items: flex-start; }
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-logo">IT LOOK Â· Analytics</div>
  <div class="login-title">
    <h1>Radar de<br><em>Performance</em></h1>
    <p>CatÃ¡logo Â· InteligÃªncia de Produto</p>
  </div>
  <button class="btn-google" onclick="signIn()">
    <svg width="18" height="18" viewBox="0 0 18 18">
      <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/>
      <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
      <path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/>
      <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
    </svg>
    ENTRAR COM GOOGLE
  </button>
  <div id="login-error" style="color:#e05c2a;font-size:12px;display:none;"></div>
</div>

<!-- APP -->
<div id="app">
  <header>
    <div class="header-brand">IT LOOK</div>
    <div class="header-title">Radar de Performance</div>
    <div class="header-user">
      <span id="user-initial" class="user-dot">D</span>
      <span id="user-name">Dani</span>
      <span style="color:var(--border)">Â·</span>
      <span style="cursor:pointer;font-size:11px;" onclick="signOut()">Sair</span>
    </div>
  </header>

  <main>

    <!-- KPIs -->
    <div class="kpi-grid" id="kpi-grid">
      <div class="kpi-card" style="--card-color:var(--estrela)" data-filter="Estrela" onclick="filterByCard(this)">
        <span class="kpi-icon">â­</span>
        <div class="kpi-label">Produto Estrela</div>
        <div class="kpi-value" id="kpi-estrela">â€”</div>
        <div class="kpi-sub">produtos</div>
      </div>
      <div class="kpi-card" style="--card-color:var(--interesse)" data-filter="Alto Interesse" onclick="filterByCard(this)">
        <span class="kpi-icon">ğŸ”¥</span>
        <div class="kpi-label">Alto Interesse</div>
        <div class="kpi-value" id="kpi-interesse">â€”</div>
        <div class="kpi-sub">baixa conversÃ£o</div>
      </div>
      <div class="kpi-card" style="--card-color:var(--problema)" data-filter="Problema de PÃ¡gina" onclick="filterByCard(this)">
        <span class="kpi-icon">âš ï¸</span>
        <div class="kpi-label">Problema de PÃ¡gina</div>
        <div class="kpi-value" id="kpi-problema">â€”</div>
        <div class="kpi-sub">requer atenÃ§Ã£o</div>
      </div>
      <div class="kpi-card" style="--card-color:var(--normal)" data-filter="Normal" onclick="filterByCard(this)">
        <span class="kpi-icon">ğŸ’¤</span>
        <div class="kpi-label">Normal</div>
        <div class="kpi-value" id="kpi-normal">â€”</div>
        <div class="kpi-sub">performance padrÃ£o</div>
      </div>
      <div class="kpi-card" style="--card-color:var(--invisivel)" data-filter="InvisÃ­vel" onclick="filterByCard(this)">
        <span class="kpi-icon">ğŸ‘»</span>
        <div class="kpi-label">InvisÃ­vel</div>
        <div class="kpi-value" id="kpi-invisivel">â€”</div>
        <div class="kpi-sub">baixÃ­ssimo alcance</div>
      </div>
    </div>

    <!-- TABLE HEADER -->
    <div class="section-header">
      <div class="section-title">CatÃ¡logo</div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <div class="search-wrap">
          <input type="text" id="search-input" placeholder="Buscar produto..." oninput="renderTable()">
        </div>
        <div class="filter-pills" id="filter-pills">
          <button class="pill active" data-status="Todos" onclick="setPill(this)">Todos</button>
          <button class="pill" data-status="Estrela" onclick="setPill(this)">â­ Estrela</button>
          <button class="pill" data-status="Alto Interesse" onclick="setPill(this)">ğŸ”¥ Alto Interesse</button>
          <button class="pill" data-status="Problema de PÃ¡gina" onclick="setPill(this)">âš ï¸ Problema</button>
          <button class="pill" data-status="Normal" onclick="setPill(this)">ğŸ’¤ Normal</button>
          <button class="pill" data-status="InvisÃ­vel" onclick="setPill(this)">ğŸ‘» InvisÃ­vel</button>
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="table-wrap animate-in">
      <table>
        <thead>
          <tr>
            <th onclick="sortBy('produto')">Produto â†•</th>
            <th onclick="sortBy('impressoes')">ImpressÃµes â†•</th>
            <th onclick="sortBy('cliques')">Cliques â†•</th>
            <th onclick="sortBy('carrinho')">Carrinho â†•</th>
            <th onclick="sortBy('compras')">Compras â†•</th>
            <th onclick="sortBy('ctr')">CTR â†•</th>
            <th onclick="sortBy('add_rate')">Add Rate â†•</th>
            <th onclick="sortBy('conversion_rate')">Conv. Rate â†•</th>
            <th>Status</th>
            <th>AÃ§Ã£o</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr><td colspan="10" class="state-msg"><span class="loading-dot">Carregando dados</span></td></tr>
        </tbody>
      </table>
    </div>

    <div style="margin-top:14px;font-size:11px;color:var(--gray);text-align:right;" id="row-count"></div>

  </main>
</div>

<!-- MODAL -->
<div id="modal-overlay" onclick="closeModal(event)">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('modal-overlay').classList.remove('open')">Ã—</button>
    <h3 id="modal-name">â€”</h3>
    <div class="modal-status" id="modal-status">â€”</div>
    <div class="modal-grid" id="modal-grid"></div>
    <div class="modal-actions" id="modal-actions"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” ajuste se necessÃ¡rio
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROJECT_ID  = 'itlook-analytics';
const DATASET     = 'analytics_395902084';
const VIEW        = 'vw_produtos_inteligente';
const CLIENT_ID   = '981412010562-1mob2lq1uavnvtj5mjjl97eh9lu6u50o.apps.googleusercontent.com'; // â† cole seu OAuth Client ID aqui (veja instruÃ§Ãµes abaixo)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allData      = [];
let currentFilter = 'Todos';
let sortCol      = 'impressoes';
let sortAsc      = false;
let tokenClient;
let accessToken;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initGoogle() {
  if (!CLIENT_ID) {
    document.querySelector('#login-screen .btn-google').textContent = 'âš  Configure o CLIENT_ID no cÃ³digo';
    return;
  }
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/bigquery.readonly',
    callback: async (resp) => {
      if (resp.error) { showError(resp.error); return; }
      accessToken = resp.access_token;
      showApp();
      await loadData();
    }
  });
}

function signIn() {
  if (!CLIENT_ID) {
    showError('Configure o CLIENT_ID no arquivo HTML (veja comentÃ¡rio no cÃ³digo).');
    return;
  }
  tokenClient.requestAccessToken();
}

function signOut() {
  google.accounts.oauth2.revoke(accessToken, () => {
    accessToken = null;
    allData = [];
    document.getElementById('app').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
  });
}

function showApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
}

function showError(msg) {
  const el = document.getElementById('login-error');
  el.textContent = msg;
  el.style.display = 'block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BIGQUERY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadData() {
  const query = `SELECT * FROM \`${PROJECT_ID}.${DATASET}.${VIEW}\` ORDER BY impressoes DESC LIMIT 500`;
  const url = `https://bigquery.googleapis.com/bigquery/v2/projects/${PROJECT_ID}/queries`;

  const res = await fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ query, useLegacySql: false, timeoutMs: 30000 })
  });

  if (!res.ok) {
    const err = await res.json();
    showTableError('Erro ao buscar dados: ' + (err.error?.message || res.status));
    return;
  }

  const data = await res.json();

  if (!data.rows) {
    showTableError('Nenhum dado encontrado na view.');
    return;
  }

  const fields = data.schema.fields.map(f => f.name);
  allData = data.rows.map(row => {
    const obj = {};
    row.f.forEach((cell, i) => {
      const val = cell.v;
      const num = parseFloat(val);
      obj[fields[i]] = isNaN(num) ? val : num;
    });
    return obj;
  });

  updateKPIs();
  renderTable();
}

function showTableError(msg) {
  document.getElementById('table-body').innerHTML =
    `<tr><td colspan="10" class="state-msg"><span>âš </span>${msg}</td></tr>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KPI CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateKPIs() {
  const count = (key) => allData.filter(r =>
    r.status_inteligente && r.status_inteligente.toLowerCase().includes(key.toLowerCase())
  ).length;

  document.getElementById('kpi-estrela').textContent   = count('Estrela');
  document.getElementById('kpi-interesse').textContent = count('Alto Interesse');
  document.getElementById('kpi-problema').textContent  = count('Problema');
  document.getElementById('kpi-normal').textContent    = count('Normal');
  document.getElementById('kpi-invisivel').textContent = count('Invis');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable() {
  const search = document.getElementById('search-input').value.toLowerCase();

  let rows = allData.filter(r => {
    const matchFilter = currentFilter === 'Todos' ||
      (r.status_inteligente && r.status_inteligente.toLowerCase().includes(currentFilter.toLowerCase()));
    const matchSearch = !search || (r.produto && r.produto.toLowerCase().includes(search));
    return matchFilter && matchSearch;
  });

  rows.sort((a, b) => {
    const av = a[sortCol] ?? 0;
    const bv = b[sortCol] ?? 0;
    if (typeof av === 'string') return sortAsc ? av.localeCompare(bv) : bv.localeCompare(av);
    return sortAsc ? av - bv : bv - av;
  });

  document.getElementById('row-count').textContent = `${rows.length} produto${rows.length !== 1 ? 's' : ''}`;

  if (!rows.length) {
    document.getElementById('table-body').innerHTML =
      `<tr><td colspan="10" class="state-msg"><span>âˆ…</span>Nenhum produto neste filtro</td></tr>`;
    return;
  }

  document.getElementById('table-body').innerHTML = rows.map((r, i) => `
    <tr>
      <td class="produto-cell" title="${r.produto || ''}">${r.produto || 'â€”'}</td>
      <td class="num">${fmt(r.impressoes)}</td>
      <td class="num">${fmt(r.cliques)}</td>
      <td class="num">${fmt(r.carrinho)}</td>
      <td class="num">${fmt(r.compras)}</td>
      <td class="pct">${pct(r.ctr)}</td>
      <td class="pct">${pct(r.add_rate)}</td>
      <td class="pct">${pct(r.conversion_rate)}</td>
      <td>${statusBadge(r.status_inteligente)}</td>
      <td><button class="action-btn" onclick='openModal(${i})'>Ver</button></td>
    </tr>
  `).join('');

  // store filtered for modal reference
  window._filteredRows = rows;
}

function fmt(v) { return v != null ? Number(v).toLocaleString('pt-BR') : 'â€”'; }
function pct(v) { return v != null ? (v * 100).toFixed(1) + '%' : 'â€”'; }

function statusBadge(s) {
  if (!s) return 'â€”';
  const sl = s.toLowerCase();
  let cls = 'normal', icon = 'ğŸ’¤';
  if (sl.includes('estrela'))    { cls = 'estrela';   icon = 'â­'; }
  else if (sl.includes('alto'))  { cls = 'interesse'; icon = 'ğŸ”¥'; }
  else if (sl.includes('probl')) { cls = 'problema';  icon = 'âš ï¸'; }
  else if (sl.includes('invis')) { cls = 'invisivel'; icon = 'ğŸ‘»'; }
  return `<span class="badge badge-${cls}">${icon} ${s}</span>`;
}

function sortBy(col) {
  if (sortCol === col) sortAsc = !sortAsc;
  else { sortCol = col; sortAsc = false; }
  renderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setPill(el) {
  document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  currentFilter = el.dataset.status;
  // unset card active
  document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active'));
  renderTable();
}

function filterByCard(el) {
  const status = el.dataset.filter;
  document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  currentFilter = status;
  document.querySelectorAll('.pill').forEach(p => {
    p.classList.toggle('active', p.dataset.status === status);
  });
  renderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(idx) {
  const r = window._filteredRows[idx];
  if (!r) return;

  document.getElementById('modal-name').textContent = r.produto || 'â€”';
  document.getElementById('modal-status').textContent = r.status_inteligente || 'â€”';

  document.getElementById('modal-grid').innerHTML = `
    <div class="modal-stat"><div class="label">ImpressÃµes</div><div class="val">${fmt(r.impressoes)}</div></div>
    <div class="modal-stat"><div class="label">Cliques</div><div class="val">${fmt(r.cliques)}</div></div>
    <div class="modal-stat"><div class="label">Carrinho</div><div class="val">${fmt(r.carrinho)}</div></div>
    <div class="modal-stat"><div class="label">Compras</div><div class="val">${fmt(r.compras)}</div></div>
    <div class="modal-stat"><div class="label">CTR</div><div class="val">${pct(r.ctr)}</div></div>
    <div class="modal-stat"><div class="label">Add Rate</div><div class="val">${pct(r.add_rate)}</div></div>
    <div class="modal-stat"><div class="label">Conv. Rate</div><div class="val">${pct(r.conversion_rate)}</div></div>
  `;

  const actions = getActions(r.status_inteligente);
  document.getElementById('modal-actions').innerHTML = actions.map((a, i) =>
    `<button class="modal-action-btn ${i === 0 ? 'primary' : ''}" onclick="${a.fn}">${a.label}</button>`
  ).join('');

  document.getElementById('modal-overlay').classList.add('open');
}

function getActions(status) {
  const s = (status || '').toLowerCase();
  if (s.includes('estrela'))   return [
    { label: 'ğŸ“£ Impulsionar AnÃºncio', fn: 'alert("Abrir campanha no Meta Ads")' },
    { label: 'ğŸ“Œ Destacar no Site',    fn: 'alert("Marcar como destaque")' },
  ];
  if (s.includes('alto'))      return [
    { label: 'ğŸ“¸ Melhorar Fotos',      fn: 'alert("Revisar fotos do produto")' },
    { label: 'âœï¸ Revisar DescriÃ§Ã£o',   fn: 'alert("Editar pÃ¡gina do produto")' },
  ];
  if (s.includes('probl'))     return [
    { label: 'ğŸ”§ Revisar PÃ¡gina',      fn: 'alert("Verificar URL e conteÃºdo")' },
    { label: 'ğŸ’° Ajustar PreÃ§o',       fn: 'alert("Revisar precificaÃ§Ã£o")' },
  ];
  if (s.includes('invis'))     return [
    { label: 'ğŸš€ Criar AnÃºncio',       fn: 'alert("Criar campanha no Meta")' },
    { label: 'ğŸ·ï¸ Adicionar Tags SEO',  fn: 'alert("Otimizar SEO do produto")' },
  ];
  return [
    { label: 'ğŸ“Š Monitorar',           fn: 'alert("Produto em observaÃ§Ã£o")' },
  ];
}

function closeModal(e) {
  if (e.target === document.getElementById('modal-overlay')) {
    document.getElementById('modal-overlay').classList.remove('open');
  }
}

// ESC fecha modal
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.getElementById('modal-overlay').classList.remove('open');
});
</script>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" onload="initGoogle()" async defer></script>

</body>
</html>
